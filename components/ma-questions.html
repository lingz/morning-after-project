<link href='../bower_components/polymer/polymer.html' rel="import">
<link href='../bower_components/core-animated-pages/core-animated-pages.html' rel="import">
<link href='../bower_components/core-animated-pages/transitions/slide-from-bottom.html' rel="import">
<link href='../bower_components/paper-button/paper-button.html' rel="import">
<link href='../bower_components/paper-fab/paper-fab.html' rel="import">
<link href='../bower_components/core-icons/core-icons.html' rel="import">
<link href='./ma-question.html' rel="import">


<polymer-element name="ma-questions" attributes="started">

  <template>
    <style>
      #begin {
        width: 100px;
        background: #134659;
        color: white;
      }
      :host {
        height: 100%;
        width: 100%;
        position: relative;
      }
      core-animated-pages {
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
    </style>

    <template id="condoms">
      The best strategy for safer sex is to use a condom. They have been proven to be highly effective at
      both preventing STIs including HIV, as well as unplanned pregnancies.
    </template>

    <template id="result">
    </template>

    <template id="result-detail">
        <template ref="condoms"></template>
      <paper-button on-click={{startOver}}>Start Over</paper-button>
    </template>

    <core-animated-pages id="pages" transitions="slide-from-bottom" layout vertical center center-justified>
      <section>
        <div layout vertical center>
          <div>
            Just had unsafe sex?
          </div>
          <div>
             We're here to help you decide what you need to do next to keep yourself healthy.
          </div>
          <div>
            100% Confidential
          </div>
          <paper-button id="begin" on-click={{start}}>Begin</paper-button>
        </div>
      </section>
      <template if={{started}}>
        <section>
          <ma-question
           question="Have you recently had unprotected sex?"
           options={{["Yes","No","Unsure"]}}
           chosen={{unprotectedSex}}
           mode="single"
           required={{text}}
           on-next={{next}}
          >
        </section>
      </template>
      <template if='{{unprotectedSex == "No"}}'>
        <section>
          <div layout vertical center>
            <div>
              Good job on using protection. Condoms are a highly effective tool to prevent STDs and pregnancy.
            </div>
            <paper-button on-click={{startOver}}>Start Over</paper-button>
          </div>
        </section>
      </template>
      <template if='{{unprotectedSex == "Unsure" || unprotectedSex == "Yes"}}'>
        <section>
          <ma-question
           question="What is your biological sex?"
           options={{["Male","Female","Intersex"]}}
           chosen={{selfSex}}
           mode="single"
           required=true
           on-next={{handleSelfSex}}
          >
          </ma-question>
        </section>
        <section>
          <ma-question
            question="What is the biological sex of your partner(s)?"
            options={{["Male","Female","Intersex"]}}
            chosen={{partnersSex}}
            mode="multiple"
            required=true
            on-next={{handlePartnerSex}}
          >
          </ma-question>
        </section>
        <section>
          <ma-question
            id="sexualActs"
            question="Which of these sexual acts did you engage in?"
            options={{possibleSexualActs}}
            chosen={{sexualActs}}
            mode="multiple"
            required={{false}}
            on-next={{handleSexualActs}}
          >
          </ma-question>
        </section>
      </template>
      <section>
        <template if='{{sexualActs.length > 0}}'>
          <div layout vertical center>
            <h1>
              You may be at risk of {{selfSex == "Female" ? "pregnancy and" : ""}} {{canHaveHIV ? "HIV" : "Gonorrhea"}} as well as other STIs.
              Seeking treatment quickly can {{canBePregnant ? "prevent pregnancy" }},
              allow rapid recovery{{canHaveHIV ? ", and prevent permanent HIV infection" : "."}}
            </h1>
            <div layout vertical horizontal>
              <div>
                Learn more about risks and treatment
                <paper-fab icon="expand-more">
                </paper-fab>
              </div>
              <div>
                Find a health clinic near you
                <paper-fab icon="link">
                </paper-fab>
              </div>
            </div>
          </div>
        </template>
        <template if='{{sexualActs.length == 0}}'>
          <h1>
            You are not at risk for STIs
          </h1>
          <template ref="condoms"></template>
          <paper-button on-click={{startOver}}>Start Over</paper-button>
        </template>
      </section>
    </core-animated-pages>
  </template>



  <script>
    var hasPenis = function(sexes) {
      if (sexes instanceof Array) {
        return sexes.indexOf("Male") > -1 || sexes.indexOf("Intersex") > -1;
      } else {
        return sexes == "Male" || sexes == "Intersex";
      }
    };
    hasVagina = function(sexes) {
      if (sexes instanceof Array) {
        return sexes.indexOf("Female") > -1 || sexes.indexOf("Intersex") > -1;
      } else {
        return sexes == "Female" || sexes == "Intersex";
      }
    }
    var self;
    Polymer("ma-questions", {
      ready: function() {
        self = this;
        this.started = false;
      },
      next: function() {
        this.$.pages.selected += 1;
      },
      start: function() {
        this.started = true;
        setTimeout(function() {
          self.next();
        }, 0);
      },
      handleSelfSex: function() {
        this.next();
      },
      handlePartnerSex: function() {
        // Always possible regardless of gender orientation
        this.possibleSexualActs = ["Receiving Oral", "Giving Oral"];

        if (hasPenis(this.selfSex)) {
          this.possibleSexualActs.push("Penetrative Partner (Anal)");
        }

        if (hasPenis(this.selfSex) && hasVagina(this.partnersSex)) {
          this.possibleSexualActs.push("Penetrative Partner (Vaginal)");
        }

        if (hasPenis(this.partnersSex)) {
          this.possibleSexualActs.push("Receiving Partner (Anal)");
          if (hasVagina(this.selfSex)) {
            this.possibleSexualActs.push("Receiving Partner (Vaginal)");
          }
        }

        // Sort the sexual acts so they always display in order in future
        this.possibleSexualActs.sort();

        var sexualActsQuestion = this.shadowRoot.querySelector("#sexualActs");
        sexualActsQuestion.rebuildOptionsRows();

        this.next();
      },
      handleSexualActs: function() {
        this.canHaveHIV = false;
        for (i = 0; i < this.sexualActs.length; i++) {
          var sexualAct = this.sexualActs[i];
          if (sexualAct.indexOf("Anal") > -1 || sexualAct.indexOf("Vaginal") > -1) {
            this.canHaveHIV = true;
            break;
          }
        }

        this.canBePregnant = false;
        if (this.selfSex != "Male") {
          for (i = 0; i < this.sexualActs.length; i++) {
            var sexualAct = this.sexualActs[i];
            if (sexualAct.indexOf("Receiving Partner (Vaginal)") > -1) {
              this.canBePregnant;
              break;
            }
          }
        }

        this.next();
      },
      startOver: function() {
        this.started = false;
        this.$.pages.selected = 0;
      }
    });
  </script>
</polymer>

